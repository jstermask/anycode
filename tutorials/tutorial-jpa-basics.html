<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<!-- Generated by JJB : Apache Maven Doxia Site Renderer 1.4 at 2019-06-12 -->
<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
            <title>astah-anycode-plugin - 
		Tutorial - JPA 2.0 - Basics</title>
            <meta name="viewport" content="width=device-width, initial-scale=1.0">
                <meta name="description" content="">
                                                                                    <meta name="Date-Revision-yyyymmdd" content="20190612" />
                                                                <meta http-equiv="Content-Language" content="en" />
                                        <!-- Le styles -->
                    <link href="../bootstrap/css/bootstrap.min.css" rel="stylesheet">
                        <link href="../bootstrap/css/bootstrap-responsive.min.css" rel="stylesheet">
                            <link href="../css/maven-theme.css" rel="stylesheet">
                                <link href="../css/site.css" rel="stylesheet">
                                    <link href="../css/print.css" rel="stylesheet" media="print" />
                                                                                
<script>(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
				(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new
				Date();a=s.createElement(o),
				m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
				})(window,document,'script','//www.google-analytics.com/analytics.js','ga');
				ga('create', 'UA-41772181-2', 'labulle.in');
				ga('send', 'pageview');</script>
                                                                                                                
                                        </head>
<body class="">
	<div class="stripe"></div>
    <div class="banner">
		<div class="navbar navbar-static-top">             
	        	        	<a class="logo" href="../index.html"><span class="anycode-logo">any<em>&lt;code/&gt;</em></span></a>
	        	        <ul class="nav pull-right" role="navigation">
	        	                                    <li class="dropdown">
            	<a id="drop1" class="dropdown-toggle" data-toggle="dropdown" role="button" href="#">
            		Documentation
            		<b class="caret"></b>
            	</a>
                            <ul class="dropdown-menu" aria-labelledby="drop1" role="menu">
                                    	<li role="presentation">

                                                    <a href="../documentation/install-guide.html" title="Install Guide">Install Guide</a>
                    </li>
                                    	<li role="presentation">

                                                    <a href="../documentation/reference-documentation.html" title="Reference documentation">Reference documentation</a>
                    </li>
                                    	<li role="presentation">

                                                    <a href="../api/anycode-uml-api/apidocs/index.html" title="Anycode UML API">Anycode UML API</a>
                    </li>
                                                                                                            	<li class="dropdown-submenu" role="presentation">

                                                    <a href="../directives/directives.html" title="Built-in directives">Built-in directives</a>
                                        <ul class="dropdown-menu" role="menu">
                                    	<li role="presentation">

                                                    <a href="../api/anycode-directive-api/apidocs/in/labulle/anycode/engine/groovy/directive/JavaDirective.html" title="Java">Java</a>
                    </li>
                                    	<li role="presentation">

                                                    <a href="../api/anycode-directive-api/apidocs/in/labulle/anycode/engine/groovy/directive/JpaDirective.html" title="JPA 2.0">JPA 2.0</a>
                    </li>
                                    	<li role="presentation">

                                                    <a href="../api/anycode-directive-api/apidocs/in/labulle/anycode/engine/groovy/directive/SpringDirective.html" title="Spring">Spring</a>
                    </li>
                                    	<li role="presentation">

                                                    <a href="../api/anycode-directive-api/apidocs/in/labulle/anycode/engine/groovy/directive/ObjectiveCDirective.html" title="Objective-C">Objective-C</a>
                    </li>
                            </ul>
            </li>
                                                                                                	<li class="dropdown-submenu" role="presentation">

                                                    <a href="../tutorials/tutorials.html" title="Tutorials">Tutorials</a>
                                        <ul class="dropdown-menu" role="menu">
                                    	<li role="presentation">

                                                    <a href="../tutorials/tutorial-java-helloworld.html" title="Java tutorial - Hello World">Java tutorial - Hello World</a>
                    </li>
                                    	<li role="presentation">

                        <a href="#"><strong>JPA tutorial - Basics</strong></a>
                </li>
                                    	<li role="presentation">

                                                    <a href="../tutorials/tutorial-objc-basics.html" title="Objective-C tutorial - Basics">Objective-C tutorial - Basics</a>
                    </li>
                            </ul>
            </li>
                            </ul>
                    </li>
                                    <li class="dropdown">
            	<a id="drop2" class="dropdown-toggle" data-toggle="dropdown" role="button" href="#">
            		About
            		<b class="caret"></b>
            	</a>
                            <ul class="dropdown-menu" aria-labelledby="drop2" role="menu">
                                    	<li role="presentation">

                                                    <a href="../about/news.html" title="Release notes">Release notes</a>
                    </li>
                                    	<li role="presentation">

                                                    <a href="../about/roadmap.html" title="Road Map">Road Map</a>
                    </li>
                                    	<li role="presentation">

                                                    <a href="../about/license.html" title="License">License</a>
                    </li>
                                    	<li role="presentation">

                                                    <a href="../about/author.html" title="Author">Author</a>
                    </li>
                            </ul>
                    </li>
    	        </ul>
	    </div>
    </div>
    <div class="container-narrow">
                
	
		<h1>JPA 2.0 tutorial - Project Tracker example</h1>
		
<div class="section">
<h2>About this tutorial<a name="About_this_tutorial"></a></h2>
			
<p>All the source code described in this tutorial is available on <a class="externalLink" href="https://bitbucket.org/jjbcarreno/anycode-sample-projects" target="_blank">anycode tutorials bitbucket repository</a></p>
		</div>
		
<div class="section">
<h2>UML Model<a name="UML_Model"></a></h2>
			
<p>For this tutorial, we consider a very (very) simple project management software
				model :
			</p>
			
<ul>
				
<li>
					A project has a name
				</li>
				
<li>It is associated with one project leader and a set of project
					members which are employees
				</li>
				
<li>Each employee has a user account</li>
			</ul>
			
<p class="center">
				<img src="../images/tutorials/pjtracker_entities.png" class="img-polaroid" alt="" />
			</p>
			
		</div>
		
<div class="section">
<h2>JPA entity template<a name="JPA_entity_template"></a></h2>
			
<p>The most important part of this tutorial is to generate JPA
				entities in java language. So let's create JPA-ENTITY template as
				follows :
			</p>
			
<p>
				<b>JPA-ENTITY-name.mda</b>
			</p>
			
<p>
				</p>
<div class="source">
<pre>
${targetDir}/${c.getFullyQualifiedName(&quot;/&quot;)}.java </pre></div>
			

			
<p>
				<b>JPA-ENTITY-content.mda:</b>
			</p>
			
<p>
				</p>
<div class="source">
<pre>
&lt;%  if(c.hasStereotype(&quot;entity&quot;)) { %&gt;
package ${c.owner.getFullyQualifiedName(&quot;.&quot;)};

@javax.persistence.Entity
${jpa.classifierSignature(c)} {
	${jpa.primaryKey(c)}
	
	&lt;%  def atts = c.attributes.findAll({!jpa.isIdentifier(it)}) %&gt;
	&lt;%  atts.each() { %&gt;
			${jpa.attribute(it)}
   	&lt;%  } %&gt;
   
  	&lt;%  atts.each() { %&gt;
			${jpa.getter(it)}
			${jpa.setter(it)}		
   	&lt;%  } %&gt;
   	
}
&lt;%  } %&gt; </pre></div>
			
	
<div class="section">
<div class="section">
<h4>Conditional rendering<a name="Conditional_rendering"></a></h4>
	
<p>
		You'll notice that we only generate a content for class with stereotype
		<b>'entity'</b>
		. This means that if a class does not have this stereotype, nothing will be generated at all. This is very convenient as you can model JPA and
		non-JPA classes in the same model.
	</p>
	</div>
<div class="section">
<h4>Primary key generation<a name="Primary_key_generation"></a></h4>
	
<p>
		<b>jpa.primaryKkey</b>
		method detects and generates entity's primary key attribute, getter and setter. Here is how detection works:
	</p>
	
<ul>
		
<li>If no attribute has &quot;id&quot; stereotype, a default primary key (Long) is generated with a sequence generator.
		</li>
		
<li>If one attribute has &quot;id&quot; stereotype, a simple primary key is generated based on that attribute
		</li>
		
<li>If there are more than one attribute, then a PK class is referenced. In this case, you should add a template to generated PK. This particular
			case is not demonstrated in this tutorial. Though, it will be shown in another one.
		</li>
	</ul>
	</div>
<div class="section">
<h4>Attributes and relationships<a name="Attributes_and_relationships"></a></h4>
	
<p>
		Using
		<b>findAll with a closure in groovy</b> we can iterate over attributes and relationships to be persisted in JPA entity. Any navigable (or unspecified navigable) association is
		included in the attributes. It generates association annotations automatically as well as default annotation options.
	</p>
	
<p>Navigability is an important point in relationship as it will tell JPA whether it is unidirectional or bidirectional. It will also help
		determining the owning side for one-to-one, one-to-many and many-to-many relationships. Here are the conditions for 2 classes A and B :
	</p>
	
<ul>
		
<li>A x-&gt; B : A is the owning side.</li>
		
<li>A -&gt; B : A is the owning side.</li>
		
<li>A x- B : A is the owning side</li>
	</ul>
	
<p>In our project tracker model, we want Project class to be the owning side for project members. JPA code will then be generated with the adequate 'mappedBy'
		option.
	</p>
		</div></div></div>
		
<div class="section">
<h2>Service classes<a name="Service_classes"></a></h2>
			
<p>In our uml model, we add a service class with one method, as follows :</p>
			
<p class="center">
				<img src="../images/tutorials/pjtracker_service.png" class="img-polaroid" alt="" />
			</p>
			
			
<div class="section">
<h3>Generate service interface<a name="Generate_service_interface"></a></h3>
				
<p>A service is generally designed as an interface and an
					implementation class. Let's create 2 templates : SERVICE-INTERFACE
					and SERVICE-IMPL :</p>
				
<p>
					<b>SERVICE-INTERFACE-name.mda</b>
				</p>
				
<p>
					</p>
<div class="source">
<pre>
${targetDir}/${c.getFullyQualifiedName(&quot;/&quot;)}/I${c.name}.java </pre></div>
				
				
<p>
					We customized class name with 'I' prefix for
					<b>I</b>nterface.
				</p>
				
<p>
					<b>SERVICE-INTERFACE-content.mda:</b>
				</p>
				
<p>
					</p>
<div class="source">
<pre>
&lt;% if(c.hasStereotype(&quot;service&quot;)) { %&gt;
package ${c.owner.getFullyQualifiedName(&quot;.&quot;)};
import java.util.List;
import ${c.owner.owner.getFullyQualifiedName(&quot;.&quot;)}.core.*;

public interface I${c.name} {
	&lt;% c.operations.each { %&gt;
		${java.operationSignature(it)};
	&lt;% } %&gt;
}
&lt;% } %&gt; </pre></div>
				
				
<p>
					Only 'service' stereotyped class will have an interface generated.
					This interface only consists in a list of operation signatures,
					generated with
					<b>java.operationSignature</b>
					method.
				</p>
			</div>
			
<div class="section">
<h3>Service implementation<a name="Service_implementation"></a></h3>
				
<p>Let's proceed to service implementation:</p>
				
<p>
					<b>SERVICE-IMPL-name.mda</b>
				</p>
				
<p>
					</p>
<div class="source">
<pre>
${targetDir}/${c.getFullyQualifiedName(&quot;/&quot;)}/impl/${c.name}.java </pre></div>
				
				
<p>We decided to generate implementation in 'impl' sub-package.</p>
				
<p>
					<b>SERVICE-IMPL-content.mda:</b>
				</p>
				
<p>
					</p>
<div class="source">
<pre>
&lt;% if (c.hasStereotype(&quot;service&quot;)) { %&gt;
package ${c.owner.getFullyQualifiedName(&quot;.&quot;)}.impl;
import java.util.List;
import org.springframework.stereotype.*;
import org.springframework.beans.factory.annotation.*;

&lt;%  def basePackage = c.owner.owner.getFullyQualifiedName(&quot;.&quot;) %&gt;
import ${basePackage}.core.*;
import ${basePackage}.dao.*;
import ${basePackage}.service.*;

@org.springframework.stereotype.Service
public class ${c.name} implements I${c.name} {
	&lt;%  c.clientDependencies.each { %&gt;
		${springData.autowiredAttribute(it)}
	&lt;% } %&gt;

	&lt;%  c.operations.each { %&gt;
		${springData.operationImplementation(it)}
	&lt;%  } %&gt;
}
&lt;%  } %&gt;</pre></div>
				
				
<p>
					Only 'service' stereotyped class will have an interface generated.
					It implements the interface. We use
					<b>java.operationImplementation</b>
					method to generate a body.
				</p>
			</div>
		</div>
		
<div class="section">
<h2>Service dependencies<a name="Service_dependencies"></a></h2>
			
<div class="section">
<h3>Generating JPA Repositories<a name="Generating_JPA_Repositories"></a></h3>
			
<p>Our service and entities are generated but not wired together. A way to connect them is to create a dependency relation in UML, like this :</p>
			
<p class="center">
				<img src="../images/tutorials/pjtracker_dependencies.png" class="img-polaroid" alt="" />
			</p>
			
<p>We can use this 'dependency' representation as a transformation rule to generated dao classes. Let's generate them with Spring Data for JPA.
			 The latter currently adds JpaRepository class generation (see <a class="externalLink" href="http://projects.spring.io/spring-data-jpa/">Spring Data JPA</a> for further details)</p>
				
<p>
					<b>DAO-name.mda</b>
				</p>
				
<p>
					</p>
<div class="source">
<pre>
${targetDir}/${c.owner.getFullyQualifiedName(&quot;/&quot;)}/../dao/${c.name}Repository.java </pre></div>
				
				
<p>We decided to generate classes in 'dao' sub-package.</p>
				
<p>
					<b>DAO-content.mda:</b>
				</p>
				
<p>
					</p>
<div class="source">
<pre>
&lt;%if(c.hasStereotype(&quot;entity&quot;)) {%&gt;

package ${c.owner.owner.getFullyQualifiedName(&quot;.&quot;)}.dao;

import java.util.List;
import ${c.owner.getFullyQualifiedName(&quot;.&quot;)}.*;

@org.springframework.stereotype.Repository
public interface ${c.name}Repository extends org.springframework.data.jpa.repository.JpaRepository&lt;${c.name},${jpa.primaryKeyDataType(c)}&gt; {
	&lt;% c.operations.findAll({jpa.isFinderOperation(it)}).each { %&gt;
	${jpa.operationSignature(it)};
	&lt;% } %&gt;
}
&lt;% } %&gt;</pre></div>
				
			</div>
			
<div class="section">
<h3>Wiring services and repositories<a name="Wiring_services_and_repositories"></a></h3>
				
<p>UML dependency can be used in Anycode UML API through <b>getClientDependencies()</b> method. We just have to add the following piece of code in our SERVICE-IMPL template, using @springData directive :</p>
				
<p></p>
<div class="source">
<pre>
[...]
&lt;% c.clientDependencies.each { %&gt;
	${springData.autowiredAttribute(it)}
&lt;%} %&gt;
[...] </pre></div>
				
<p>This will add a reference to the above repository class, as well as a getter and a setter. On top of that spring @AutoWired annotation will be added.</p>			
			</div>
			
<div class="section">
<h3>Adding query methods to repositories<a name="Adding_query_methods_to_repositories"></a></h3>
				
<p>Spring data make queries easy thanks to query methods. In the above diagram, you may have noticed a method on Project class : @findByName. This notation is inspired by AndroMDA project and can be used as a transformation rule to add query methods
				on the repository.</p>
				
<p>To do that, just add the following lines in DAO template :</p>
				
<p>
				</p>
<div class="source">
<pre>
[...]
&lt;% c.operations.findAll({jpa.isFinderOperation(it)}).each { %&gt;
	${jpa.operationSignature(it)};
&lt;% } %&gt;
[...] </pre></div>
			
<p>jpa.operationSignature is the same as java.operationSignature except that it will take all methods starting with @ in the entity class and put them in the repository class.</p>
			</div>
		</div>
		
<div class="section">
<h2>Testing your source code<a name="Testing_your_source_code"></a></h2>
			
<p>The sources of this tutorial are available online  <a class="externalLink" href="https://bitbucket.org/jjbcarreno/anycode-sample-projects" target="_blank">here</a>. It contains a maven project with HSQL unit tests run with Spring tests with custom data load. </p>
		</div>
	
 
        <div class="clear"></div>
    </div>
    <footer class="navbar-fixed-bottom">
        <div class="container-narrow">
            <p class="pull-right">
            	                                                <a href="https://bitbucket.org/jjbcarreno/anycode/issues" class="externalLink" target="_blank" title="Issue Tracker">Issue Tracker</a>
                        	<a href="../index.html"><i class="icon-home icon-white"></i>Home</a>
                <a href="#"><i class="icon-arrow-up icon-white"></i>Top</a>
            </p>
            <p>                        2013-2019
            <a href="http://www.labulle.in">LaBulle.in</a>.
        </p>
        </div>
    </footer>
    <script src="../bootstrap/assets/js/jquery.js"></script>
    <script src="../bootstrap/js/bootstrap.min.js"></script>  
</body>
</html>
